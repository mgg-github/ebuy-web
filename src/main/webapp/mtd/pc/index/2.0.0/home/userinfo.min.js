define("home/widget/userinfo",function(require,exports,module){"use strict";var e=require("conf"),i=require("load_async"),r=_.Class.extend({construct:function(e){this.conf=$.extend({$el:null},e),this.init()},init:function(){this.loginDeferred=new $.Deferred,this.getTpl(),this.checkUser(),this.initEvent()},renderDefer:new $.Deferred,initEvent:function(){_.eventCenter.on("home:load",$.proxy(function(){$.when(this.loginDeferred).then($.proxy(function(){this.isLogin&&$.when(pageConfig.userInfoDefer,this.renderDefer).done($.proxy(function(e){var i=e;if(i&&i.imgUrl){var r=i.imgUrl;$(".J_user_info_avatar_img",this.conf.$el).attr("src",r)}},this))},this))},this))},getTpl:function(){var e='        {% var clstagPrefix = pageConfig.clstagPrefix + "09"; %}        <div class="user_info user_info_level{%= o.userLevel %} user_info_plus{%= o.plusState %}" clstag="{%= clstagPrefix + "a" %}">          <div class="J_user_info_avatar user_info_avatar">            <img class="J_user_info_avatar_img" src="{%= o.imgUrl %}" />            <a class="user_info_avatar_lk" href="{%= o.homeUrl %}" target="_blank"></a>          </div>          {% if (o.isLogin && o.nickName && o.nickName.length) { %}            <div class="user_info_show">              <p>                <i class="user_info_plusico"></i>                Hi，<a href="{%= o.homeUrl %}">{%= o.nickName %}</a></p>              <p>                <a class="user_info_lv" href="//vip.taotao.com" target="_blank">                  <i class="user_info_lvico"></i>{%= o.userLevelTxt %}                </a>                <a class="user_info_logout" href="{%= o.logoutUrl %}">退出</a>              </p>            </div>          {% } else { %}            <div class="user_info_show">              {% if (o.nickName && o.nickName.length) { %}                <p>Hi，<a href="{%= o.homeUrl %}">{%= o.nickName %}</a></p>              {% } else { %}                <p class="user_info_tip">Hi，欢迎来到京东！</p>              {% } %}              <p>                <a href="javascript:login();" class="user_info_login">登录</a>                <a href="javascript:regist();" class="user_info_reg">注册</a>              </p>            </div>          {% } %}      </div>      <div class="user_profit">        {% if (o.isNew || !o.isLogin) { %}          <a class="user_profit_lk" href="{%= o.xinrenUrl %}" target="_blank" clstag="{%= clstagPrefix + "b" %}">新人福利</a>          <a class="user_profit_lk" href="{%= o.plusUrl %}" target="_blank" clstag="{%= clstagPrefix + "c" %}">PLUS会员</a>        {% } else { %}          <a class="user_profit_lk user_profit_lk_long" href="{%= o.vipUrl %}" target="_blank" clstag="{%= clstagPrefix + "d" %}">            {%= o.vipPromo %}          </a>        {% } %}      </div>';return e},checkNewUser:function(){var r=e.INTERFACE.NEW_USER;return i({url:r,timeout:1e3,jsonpCallback:"jsonpCallbackIsNewuser"})},checkUser:function(){function i(e){var i=require("o2tpl"),n=i(r.getTpl(),e);s.removeClass("mod_loading").html(n),_.eventCenter.trigger("render:userinfo"),o.resolve()}var r=this,s=r.conf.$el,n=e.URLS,o=this.renderDefer,t={homeUrl:n.HOME,loginUrl:n.LOGIN,logoutUrl:n.LOGOUT,registUrl:n.REGIST,xinrenUrl:n.XINREN,vipUrl:"",vipPromo:"",plusState:0,userLevel:"",isLogin:!1,isNew:!1,plusUrl:n.PLUS,nickName:pageConfig.user.pin,imgUrl:"//taotao.com/mtd/pc/common/img/no_login.jpg"};$.when(pageConfig.loginDefer,pageConfig.userInfoDefer).then(function(e,s){var n,o=s.userLevel||1,a=s.plusStatus in{1:1,2:1,3:1,4:1}?s.plusStatus:0,l={1:"注册会员",2:"铜牌会员",3:"银牌会员",4:"金牌会员",5:"钻石会员",6:"VIP会员",7:"企业会员"}[o]||"注册会员";if(n=pageConfig.plusMap[o-1]||plus.plusMap[0],n=n[a]||n[4],t.vipUrl=n[0],t.vipPromo=n[1].replace(/\<span[ \s\S]+span>/g,"").replace(/>/g,""),t.plusState=a,t.userLevel=o-1,t.userLevelTxt=l,e&&e.Identity){var f=e.Identity,c=f.IsAuthenticated;if(c){var g=f.Unick||f.Name;t.isLogin=c,r.isLogin=c,r.loginDeferred.resolve(),r.checkNewUser().then(function(e){if(e){"string"==typeof g&&g.length&&(t.nickName=g);var r=e;"10000"===r.STATE&&(t.isNew=r.isNew),pageConfig.isNewUser=t.isNew,i(t)}else i(t)},function(){i(t)})}else r.loginDeferred.reject(),i(t)}else r.loginDeferred.reject(),i(t)},function(){r.loginDeferred.reject(),i(t)})}});return r});