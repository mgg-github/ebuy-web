seajs.use(["conf", "store", "o2tpl", "o2console", "load_async", "report", "mtd/pc/components/lazyload.js"], function (e, o, t, r, a, i, n) {
    "use strict";
    var s = window.pageConfig, l = _.Class.extend({
        statics: {
            CONTROL: "o2Control",
            ANI_SWITCH: "ANI_SWITCH",
            NEED_ANI: "need_ani",
            ACT_CLASS: "A_act",
            RENDER_BEFORE: "render:before",
            RENDER_AFTER: "render:after"
        }, construct: function (e) {
            this.conf = $.extend({
                cls: "J_lazyload",
                scrollEvent: "scroll.lazydata resize.lazydata",
                timer: {autoLoad: 3e3}
            }, e), this.init()
        }, init: function () {
            this.w = window, this.$w = $(window);
            var e = $("html"), o = s.o2AppName || "";
            "" !== o && e.addClass(o), r.consoleConfigFunc(), this.isChrome = e.hasClass("o2_chrome"), this.isIE = !!this.w.ActiveXObject || navigator.userAgent.indexOf("Trident") > 0, this.o2JSConfig = s ? s.o2JSConfig : {}, this.imageLazyload = s.imageLazyload, this.resourceLoader = null, this.loadingData = {}, this.insertedStyles = [], this.loadingTpl = [], this.renderedFloor = [], this.floorResult = {}, this.isAutoRendered = !1, this.lazyFloorCount = 0, this.aniFloorCount = 0, this.loadedFloorCount = 0, this.aniedFloorCount = 0, this.initFloor(), this.floorsInfo = this.getFloorsInfo($(".J_f")), this.lazyLoadFloor(), this.bind(), this.events = $._data($("body").get(0), "events")
        }, initFloor: function () {
            var e = this, o = $("." + e.conf.cls);
            o.each(function (o, t) {
                e.lazyFloorCount++;
                var r = $(t);
                r.hasClass(l.NEED_ANI) && e.aniFloorCount++
            })
        }, bind: function () {
            var e = this.isIE ? {delay: 60, threshold: 500} : {delay: 20, threshold: 1e3};
            this.imageLazyload || (e.source = "nolazyload"), e.quality = 90, e.webpQuality = 90;
            var o = this, r = o.$w, a = o.w;
            $("body").o2lazyload(e).bind("render", this.conf.cls, function (e, r, i) {
                var n = $(e.target), s = n.attr("id"), d = o.floorsInfo[s], h = d.custom;
                if (!($.inArray(s, o.renderedFloor) >= 0)) {
                    var c = n.find('[type="text/template"]'), u = "";
                    if ("object" == typeof r && r.dom ? u = r.dom : (u = c.html(), r.dom = u), o.floorResult[s] = {result: r}, h) {
                        if (h && i)return o.detectFloorNeedAni(n) && (n.addClass(l.ACT_CLASS), o.aniedFloorCount++), n.trigger(l.RENDER_AFTER, [r, function () {
                            _.eventCenter.trigger("lazyload:DOMUpdate", n), n.removeClass("mod_lazyload"), o.sendClog(n)
                        }])
                    } else o.renderedFloor.push(s);
                    var f = $.isEmptyObject(r.data) ? null : r.data, g = d.source;
                    if (g && (!f || $.isEmptyObject(f)))return void o.hideFloor(s, n);
                    try {
                        var p = "";
                        i ? (p = t(u, f || {}), c.remove(), a.requestNextAnimationFrame(function () {
                            o.detectFloorNeedAni(n) && (o.aniedFloorCount++, n.addClass(l.ACT_CLASS)), n.append(p), n.trigger(l.RENDER_AFTER, r), _.eventCenter.trigger("lazyload:DOMUpdate", n), o.sendClog(n)
                        })) : h || (p = t(u, f || {}), c.remove(), o.floorResult[s].html = p, n.attr("data-hidden", !0))
                    } catch (e) {
                        o.hideFloor(s, n), _.console.log(e)
                    }
                }
            }), _.eventCenter.on("render:floorChange", function () {
                o.floorChange = !0, o.windowLoaded && r.trigger(o.conf.scrollEvent.split(" ")[1])
            }), r.one("load.render", function () {
                o.windowLoaded = !0, o.preloadOffset = o.isIE ? 500 : 800, o.preloadOffset = o.detectNeedAni() ? 0 : o.preloadOffset, o.startLoadTimer = setTimeout(function () {
                    r.trigger(o.conf.scrollEvent.split(" ")[1])
                }, 20)
            })
        }, lazyLoadFloor: function () {
            var e = this, o = e.$w, t = (e.w, $(document)), r = e.conf, a = null,
                i = e.isAutoRendered ? 20 : e.isIE ? 200 : 100;
            e.preloadOffset = 0;
            var n = e.floorsInfo;
            o.bind(r.scrollEvent, function (l) {
                e.isScrolling = !0, e.startLoadTimer && clearTimeout(e.startLoadTimer), e.autoLoadTimer && clearTimeout(e.autoLoadTimer), a && clearTimeout(a), e.resourceLoader && e.resourceLoader.pause(), a = setTimeout(function () {
                    e.isScrolling = !1, e.floorChange && (n = e.getFloorsInfo($(".J_f")), e.floorChange = !1);
                    var a = t.scrollTop(), i = o.height(), l = a + i + e.preloadOffset;
                    for (var d in n) {
                        var h = n[d], c = h.$el, u = !!c[0].getAttribute("data-hidden");
                        (h.force || h.top <= l && h.top >= a - h.height) && c[0].className.indexOf(r.cls) >= 0 && (u ? e.renderHidden(d) : e.loadData(d, !0)), e.lazyFloorCount === e.loadedFloorCount && o.unbind(r.scrollEvent)
                    }
                    s.idleTimeLoad && (e.autoLoadTimer = setTimeout($.proxy(e.autoLoad, e), 3e3))
                }, i)
            })
        }, hideFloor: function (e, o) {
            o.height(0).hide(), i.processHidedFloor(s.reportFloorHideHash[e]), _.eventCenter.trigger("render:floorChange", e), _.console.log(e + "加载失败！")
        }, getFloorsInfo: function (e) {
            var o = {};
            return e.each(function (e, t) {
                var r = $(t), a = r.attr("id"), i = r.data("rel"), n = $("#" + i), s = r.offset().top;
                i && n.length && (s = n.offset().top), o[a] = {
                    $el: r,
                    top: s,
                    height: r.outerHeight(!0),
                    force: !!r.data("forcerender"),
                    tpl: r.data("tpl"),
                    source: r.data("source"),
                    backup: r.data("backup"),
                    custom: !!r.data("custom"),
                    hidden: !1,
                    isNeedAni: r.hasClass(l.NEED_ANI),
                    animated: !1
                }
            }), o
        }, sendClog: function (e) {
            var o = e.find("[fclog]");
            o.length && setTimeout(function () {
                s.sendClog(o)
            }, 200)
        }, loadTpl: function (e, o, t) {
            var r = this.floorsInfo[e], a = r.$el, n = a.html(), l = r.tpl, d = this.w.tplVersion;
            if (!l || !d)return this.triggerRender(e, n, {data: o}, t);
            var h = !0, c = "jsonCallBack_" + l, u = this.o2JSConfig.tplPathRule(l), f = d[l],
                g = s.tplLoadTimeout || 4e3;
            _.eventCenter.on(c + ":end", $.proxy(function (r) {
                this.loadingTpl.pop(l), r.data = o;
                var a = r.style;
                a && a.length > 0 && $.inArray(l, this.insertedStyles) < 0 && (s.insertStyles(l, a), this.insertedStyles.push(l)), this.loadingData[e] = !1, this.triggerRender(e, n, r, t)
            }, this)), $.inArray(l, this.loadingTpl) < 0 && (this.loadingTpl.push(l), this.loadCore(u, c, {__trigger: !0}, h, f, g, null, !0).fail($.proxy(function () {
                this.loadingTpl.pop(l), this.loadingData[e] = !1, this.loadedFloorCount++, a.removeClass(this.conf.cls).removeClass("mod_lazyload"), this.hideFloor(e, a), i.processTempl(s.reportFloorHideHash[e])
            }, this)))
        }, loadData: function (e, t) {
            var r = this.floorsInfo[e], a = s.dataStore, i = (r.$el, r.source);
            if (!i)return this.loadTpl(e, {}, t);
            var n = r.backup;
            "string" == typeof n && (n = this.o2JSConfig.backupPathRule(n));
            var l = i.split("|"), d = l.length, h = [], c = {};
            if (!this.loadingData[e]) {
                this.loadingData[e] = !0;
                for (var u = 0, f = 0; f < d; f++) {
                    var g, p = l[f], C = p.split(":"), v = p, m = !1, y = C.length;
                    switch (y) {
                        case 1:
                            C.push(C[0]);
                        case 2:
                            C.push(C[1]);
                        default:
                            /^(cms)|(bi)$/.test(C[0]) && (g = RegExp.$1 || RegExp.$2), m = "cms" === g, C.shift(), p = C[0], v = C[1]
                    }
                    "boolean" == typeof a && (m = a);
                    var E = encodeURIComponent("jsonCallBack" + v), _ = this.o2JSConfig.sourcePathRule(p),
                        F = this.w.sourceVersion[p];
                    if (t) {
                        var A = this.loadCore(_, E, {}, m, F, null, n, !1, function (e) {
                            return !(!e || !e.data)
                        });
                        "object" == typeof A && ("function" == typeof A.always ? h.push(A) : c[_] = A)
                    } else {
                        var T = o.get(_);
                        T && T.version && T.version === F && (u++, c[_] = T.data)
                    }
                }
                if (!t && u !== d)return void(this.loadingData[e] = !1);
                var y = h.length;
                if (y > 0) $.when.apply(null, h).done($.proxy(function () {
                    var e = arguments;
                    if (1 === y) {
                        var o = e[0];
                        c = o.data ? o.data : o
                    } else for (var t = 0; t < e.length; t++)for (var o = e[t][0], r = o.__uri, a = 0; a < l.length; a++)this.o2JSConfig.sourcePathRule(l[a]) === r && (c[l[a]] = o.data ? o.data : o)
                }, this)).always($.proxy(function () {
                    this.loadTpl(e, c, t)
                }, this)); else {
                    if (1 === d) {
                        c[0];
                        for (var R in c)c = c[R]
                    }
                    this.loadTpl(e, c, t)
                }
            }
        }, loadCore: function (o, t, r, i, n, s, l, d, h) {
            return a({
                url: o,
                jsonpCallback: t,
                params: r,
                needStore: i,
                storeSign: n,
                backup: l,
                timeout: s || e.TIMEOUT,
                cache: !!d,
                dataCheck: h
            })
        }, autoLoad: function () {
            var e = this, o = e.conf, t = e.getFloorsInfo($("." + o.cls));
            if (!e.isScrolling) {
                for (var r in t) {
                    var a = t[r], i = a.$el, n = !!i[0].getAttribute("data-hidden");
                    n || e.loadData(r, !1)
                }
                setTimeout(function () {
                    var o = $("body").find('img[data-lazy-img!="done"]'), t = [];
                    o.each(function () {
                        var e = $(this).attr("data-lazy-img");
                        "string" == typeof e && e.indexOf("//") >= 0 && t.push({type: "image", uri: e})
                    }), e.resourceLoader ? (e.resourceLoader.clear(), e.resourceLoader.load(t), e.isAutoRendered = !0) : seajs.use("O2_COMPONENT/resourceLoader.js", function (o) {
                        e.resourceLoader = o, e.resourceLoader.load(t), e.isAutoRendered = !0
                    })
                }, 2e3)
            }
        }, detectNeedAni: function () {
            return !(!this.isChrome || !s.animationOn) && !this.w.o2Control.get(l.ANI_SWITCH)
        }, detectFloorNeedAni: function (e) {
            return !(!this.detectNeedAni() || !e.hasClass(l.NEED_ANI) || e.hasClass(l.ACT_CLASS))
        }, renderHidden: function (e) {
            var o = this.floorsInfo[e], t = o.$el, r = this.floorResult[e], a = $(r.html);
            this.loadedFloorCount++, t.removeClass(this.conf.cls).removeClass("mod_lazyload").append(a), o.hidden = !1, this.detectFloorNeedAni(t) && (this.aniedFloorCount++, t.addClass(l.ACT_CLASS)), t.trigger(l.RENDER_AFTER, r.result).removeAttr("data-hidden"), _.eventCenter.trigger("lazyload:DOMUpdate", t)
        }, triggerRender: function (e, o, t, r) {
            var a = this.floorsInfo[e], i = a.$el;
            if (i.hasClass(this.conf.cls)) {
                var n = this.events, s = n[l.RENDER_BEFORE], d = !1;
                s.forEach(function (e, o) {
                    if ($(e.selector).is(i))return d = !0
                });
                var h = a.custom;
                r && (this.loadedFloorCount++, i.removeClass(this.conf.cls)), d ? i.html(o).trigger(l.RENDER_BEFORE, [t, $.proxy(function (o) {
                    return "boolean" != typeof o || o ? (t.data = arguments[0] || t.data, !h && r && i.removeClass("mod_lazyload"), void i.trigger("render", [t, r])) : void this.hideFloor(e, i)
                }, this)]) : (i.html(o), !h && r && i.removeClass("mod_lazyload"), i.trigger("render", [t, r]))
            }
        }
    });
    new l
});