define("home/widget/entry",["O2_COMPONENT/carousel/1.0.0/carousel.js"],function(require){"use strict";var e=require("O2_COMPONENT/carousel/1.0.0/carousel.js"),i=require("conf"),t=(require("logger"),function(e,i){$.extend(this,new _.Events),this.opts=$.extend({width:390,height:350,volume:1,fulllife:3},e);var t,s=pageConfig.user.jda;t="string"==typeof s?pageConfig.getHashProbability(readCookie("__jda").split(".")[1],100):0,this.life=this.opts.fulllife,this.PERCENT=t,this.init_callback=i,this.$container=$(this.opts.container),this.timeouts=[],this.available=!1,this._bind_events()});t.prototype._bind_events=function(){var e=this;this.on("player_loaded",function(){e.play()})},t.prototype.init=function(){pageConfig.useFlashPlayer="13"in pageConfig.isdebug,pageConfig.useH5Player="14"in pageConfig.isdebug;var e=pageConfig.useFlashPlayer||/(Trident|msie ([\d.]+))/i.test(navigator.userAgent);return pageConfig.useH5Player&&(e=!1),e?this.MODE="flash":this.MODE="videojs",this["_init_player_"+this.MODE](),this},t.prototype._init_player_videojs=function(){var e,t,s=this,l=s.opts.src;this.VIDEOJS_OPTIONS={controls:!1,autoplay:!0,preload:"auto",width:s.opts.width,height:s.opts.height,flash:{swf:i.VIDEOJS_SWF},techOrder:["html5","flash"]},1==l.status?(s.isLive=!0,e="application/x-mpegURL",t=s.PERCENTAGE<l.percentage?l.selfH5Pull:l.h5Pull):3==l.status&&(s.isLive=!1,e="video/mp4",t=l.mp4pull),s.src={src:t,type:e},this.trigger("waiting"),require.async("home/videojs",function(){s.$player=$('<video class="video-js">'),s.$container.append(s.$player),videojs(s.$player[0],s.VIDEOJS_OPTIONS,function(){s.player=this,s.player.on("playing",function(){s.life=s.opts.fulllife,s.trigger("playing")}).on("waiting",function(){s.trigger("waiting")}).on("pause",function(){s.trigger("pause")}).on("error",function(){s.trigger("error")}),s.trigger("player_loaded")})})},t.prototype._init_player_flash=function(){var e=this;this.SWF_PLAYER=i.SWF_PLAYER,this.FLASH_ID="J_flash_player",this.FLASH_VER="11.1.0",this.FLASH_XISWFURL="playerProductInstall.swf",this.FLASH_VARS={autoPlay:"true",preLoading:"true"},this.FLASH_PARAMS={quality:"high",bgcolor:"#333333",allowscriptaccess:"always",allowfullscreen:"true",wmode:"opaque"},this.FLASH_ATTRIBUTES={id:this.FLASH_ID,"class":"live_player J_live_player",name:"live_player",align:"middle"},require.async("home/swfobject",function(){var i,t,s,l=e.opts.src;3==l.status?(i=l.shortPull,t="1"):(t="2",(e.PERCENTAGE<l.percentage?l.selfPull:l.mPull).replace(/^([\s\S]+?)([^\/]+)$/,function(e,t,l){i=t,s=encodeURIComponent(l)})),e.flashvars=$.extend({},e.FLASH_VARS,{url:i,type:t,key:s}),e.startTime=(new Date).getTime(),e.$container.append($('<div id="'+e.FLASH_ID+'"></div>')),e.trigger("player_loaded")})},t.prototype.reload=function(){this.life--,0==this.life?this.trigger("onroad"):this["reload_"+this.MODE]()},t.prototype.reload_videojs=function(){this.player.dispose(),this._init_player_videojs()},t.prototype.play=function(){this["play_"+this.MODE](),this.available=!0,this.startTime=(new Date).getTime()},t.prototype.play_flash=function(){var e=this;this.player=swfobject.getObjectById(this.FLASH_ID),e.player?"function"==typeof e.player.SetVideoPlay&&(e.player.SetVideoPlay(),e.trigger("playing")):(swfobject.embedSWF(e.SWF_PLAYER,e.FLASH_ID,"100%","100%",e.FLASH_VER,e.FLASH_XISWFURL,e.flashvars,e.FLASH_PARAMS,e.FLASH_ATTRIBUTES),swfobject.createCSS(e.FLASH_ID,"display:block;text-align:left;"),e.player=swfobject.getObjectById(e.FLASH_ID),setTimeout(function(){e.set_volume(e.opts.volume)},800),e.trigger("playing"))},t.prototype.play_videojs=function(){this.player.currentSrc()?this.player.play():this.player.src(this.src)},t.prototype.pause=function(){this["pause_"+this.MODE]()},t.prototype.pause_flash=function(){this.player=swfobject.getObjectById(this.FLASH_ID),"function"==typeof this.player.SetVideoPause&&(this.player.SetVideoPause(),this.trigger("pause"))},t.prototype.pause_videojs=function(){this.player&&this.player.el()&&this.player.pause()},t.prototype.set_volume=function(e){this["set_volume_"+this.MODE](e)},t.prototype.set_volume_flash=function(e){this.player=swfobject.getObjectById(this.FLASH_ID),this.player&&this.player.SetSoundValue(e)},t.prototype.set_volume_videojs=function(e){this.player&&this.player.el()&&this.player.volume(e)},t.prototype.dispose=function(){this.available=!1,this.trigger("dispose");for(var e=this.timeouts.length;e--;)clearTimeout(this.timeouts[e]);this["dispose_"+this.MODE](),this.player=null},t.prototype.dispose_flash=function(){swfobject.removeSWF(this.FLASH_ID)},t.prototype.dispose_videojs=function(){this.player&&this.player.el()&&this.player.dispose()},t.prototype.get_startTime=function(){return this.startTime},t.prototype.setTimeout=function(e,i){var t=setTimeout(e,i);return this.timeouts.push(t),t},t.prototype.clearTimeout=function(e){clearTimeout(e)};var s=function(e){this.opts=$.extend({},e),this.$el=this.opts.$el,this.$live=$("#J_live",this.$el),this.$player_ctn=$(".J_live_player",this.$live),this.$playbtn=$(".J_live_playbtn",this.$live),this.$tip=$(".J_live_tip",this.$live),this.data=this.opts.data,this.reload_sel=".J_live_reload",this.is_playing=!1,this.events=new _.Events,this.clstagPrefix=pageConfig.clstagPrefix+this.data.staticLogTag,this.logged=!1;var i=readCookie("__jda");"string"==typeof i?this.PERCENTAGE=pageConfig.getHashProbability(readCookie("__jda").split(".")[1],100):this.PERCENTAGE=0,this.FULL_VOL=60,this.DURATION=15,this.TIME_LIMIT=20,this.LIVETIME_LIMIT=20,this.CAROUSEL_TIMER=350,this.SCROLL_TIMEOUT=300,this.ALL_STATUS="live_playing live_paused live_error live_end live_loading live_onroad",this.SCROLL_EVENTS="scroll.live resize.live",this.LIVE_STATUS="live_playback",this.PLAYER_WIDTH=390,this.PLAYER_HEIGHT=350,this.PLAYER_TOP=$("#entry_1").offset().top,this.volume=1,this.init()};return s.prototype.init=function(){this.bind_slider(),this.bind_play_btn(),this.bind_player_events()},s.prototype.bind_player_events=function(){var e=this;this.events.on("waiting",function(i){e.$live.removeClass(e.ALL_STATUS).addClass("live_loading"),e._show_tip("loading")}).on("playing",function(i){e.logged=!1,e._hide_tip(),e.$live.removeClass(e.ALL_STATUS).addClass("live_playing")}).on("pause",function(i){e._hide_tip(),e.$live.removeClass(e.ALL_STATUS).addClass("live_paused")}).on("error",function(i){e._log(1),e.driver.dispose(),e.$live.removeClass(e.ALL_STATUS).addClass("live_error"),e._show_tip("error")}).on("onroad",function(){e.driver.dispose(),e.$live.removeClass(e.ALL_STATUS).addClass("live_onroad"),e._show_tip("onroad")})},s.prototype.bind_slider=function(){var i=this,t=(i.data.live,".J_live_list"),s=".J_live_item",l=".J_live_img",a=".J_live_ind_item",o=".J_live_btn_pre",r=".J_live_btn_next",n=$(".J_live_playbtn",i.$live),_=$(".J_live_disablelk",i.$live),v=$(s,i.$live),p=$(a,i.$live),c=($(".J_live_info_name",i.$live),$(".J_live_info_desc",i.$live),$(".J_live_status",i.$live)),d=$(".J_live_bar_tit",i.$live),u=v.length;this.carousel=new e({container:$(t,i.$live),itemSelector:s,activeClass:"active",startIndex:0,duration:300,delay:3e3,zIndex:0,switchType:"fade",onFirstSwitch:function(e){var t=$(l,v.eq(e)),s=$(l,v.eq((e+1)%u));$.each([t,s],function(e,i){i.one("load",function(){i.parent().removeClass("mod_loading")}).attr("src",i.attr("lazy-src"))}),0==e&&4==i.data.live[0].status&&i.$live.addClass("live_disabled")},onBeforeSwitch:function(e,t){i.is_playing=!1;var s=i.data.live[t];p.eq(e).removeClass("active"),p.eq(t).addClass("active"),d.html('<i class="live_bar_tit_ico"></i>'+s.title),1==s.status?(i.$live.removeClass("live_disabled"),c.removeClass("live_playback").html('<span class="live_status_led"></span>直播中')):3==s.status?(i.$live.removeClass("live_disabled"),c.addClass("live_playback").html('<span class="live_status_led"></span>回放'+s.pageView+"次")):4==s.status&&i.$live.addClass("live_disabled"),n.attr("clstag","h|keycount|2016|"+i.data.staticLogTag+"b0"+(1+t)),_.attr("clstag","h|keycount|2016|"+i.data.staticLogTag+"g0"+(1+t))}}),this.carousel.$container.unbind("mouseenter mouseleave"),this.$live.delegate(o,"click",function(){i.carousel.switchToPrev()}).delegate(r,"click",function(){i.carousel.switchToNext()});var h=!1;this.$live.bind("mouseenter",function(){i.carousel.stop()}).bind("mouseleave",function(){i.is_playing||i.carousel.start()}).delegate(a,"mouseenter",function(e){if(!h){h=!0;var t=p.index(e.currentTarget);i.carousel.switchTo(t),setTimeout(function(){h=!1},i.CAROUSEL_TIMER)}})},s.prototype.bind_play_btn=function(){var e=".J_live_playbtn",i=".J_live_btn",t=".J_live_mask",s=".J_live_volume_bar",l=this,a=l.carousel.getCurrent(),o=(l.data.live[a],$(".J_live_volume_bar_inner",this.$live));this.$live.delegate(e,"click",function(){l.is_playing=!0}).delegate([e,t].join(","),"click",function(){return l.$live.is(".live_paused")?(l.driver.play(),!1):l.$live.is(".live_playing")?(l.driver.pause(),l._log(0),!1):void 0}).delegate(i,"click",function(){l.driver&&l.driver.available&&l.driver.dispose(),l._hide_tip(),l.$live.hasClass("live_playing")&&l._log(0),l.$live.removeClass(l.ALL_STATUS)}).delegate(e,"click",function(e){if(!l.driver||!l.driver.available){if(l.$live.is(".live_disabled"))return;l.carousel.stop(),l._init_player()}}).delegate(l.reload_sel,"click",function(){l.driver.dispose(),l._init_player()}).delegate(s,"mousedown",function(e){l.is_ajusting_volume=!0,l.volume=e.offsetX/l.FULL_VOL,o.width(100*l.volume+"%"),l.driver.available&&l.driver.set_volume(l.volume)}).delegate(s,"mousemove",function(e){l.is_ajusting_volume&&(l.volume=e.offsetX/l.FULL_VOL,o.width(100*l.volume+"%"),l.driver.available&&l.driver.set_volume(l.volume))}),$(document).bind("mouseup.entry",function(e){l.is_ajusting_volume=!1});var r=!1,n=$(document),v=$(window);_.eventCenter.on("render:floorChange",function(){l.PLAYER_TOP=l.$player_ctn.offset().top}),v.bind(l.SCROLL_EVENTS,function(){if(!r){r=!0,setTimeout(function(){r=!1},l.SCROLL_TIMEOUT);var e=n.scrollTop(),i=v.height();e<l.PLAYER_TOP&&e+i>l.PLAYER_HEIGHT+l.PLAYER_TOP||l.$live.hasClass("live_playing")&&(l.driver.pause(),l.logged||(l.logged=!0,l._log(0)))}})},s.prototype._log=function(e){var i,t=this,s=t.carousel.getCurrent(),l=t.data.live[s];i=((new Date).getTime()-t.driver.get_startTime())/1e3,i=Math.min(t.DURATION,i),log("pc_homepage","live_video",readCookie("__jdv"),1+t.carousel.getCurrent(),l.status,l.id,e,i)},s.prototype._show_tip=function(e){var i=null,t=this;switch(e){case"end":i='<div class="live_tip_txt">          前往 <a class="live_tip_lk" href="//jdlive.taotao.com" clstag="'+t.clstagPrefix+"d0"+(1+t.carousel.getCurrent())+'" target="_blank">直播频道</a><i class="live_tip_lk_ico"></i> ，继续观看<br>          淘淘APP观看直播，立享优惠！        </div>';break;case"error":i='<div class="live_tip_img"></div>        <div class="live_tip_txt">          加载超时，请尝试 <a class="live_tip_lk J_live_reload" href="javascript:;" clstag="'+t.clstagPrefix+"e0"+(1+t.carousel.getCurrent())+'">重新加载</a><i class="live_tip_lk_ico"></i><br>          前往 <a class="live_tip_lk" href="//jdlive.taotao.com" clstag="'+t.clstagPrefix+"d0"+(1+t.carousel.getCurrent())+'" target="_blank">直播频道</a><i class="live_tip_lk_ico"></i> ,观看更多精彩直播！        </div>';break;case"onroad":i='<div class="live_tip_img"></div>        <div class="live_tip_txt">          主播正在飞奔而来的路上 <a class="live_tip_lk J_live_reload" href="javascript:;" clstag="'+t.clstagPrefix+"e0"+(1+t.carousel.getCurrent())+'">刷新看看</a><i class="live_tip_lk_ico"></i><br>          前往 <a class="live_tip_lk" href="//jdlive.taotao.com" clstag="'+t.clstagPrefix+"d0"+(1+t.carousel.getCurrent())+'" target="_blank">直播频道</a><i class="live_tip_lk_ico"></i> ,观看更多精彩直播！        </div>';break;case"loading":i='<div class="live_tip_img"></div>        <div class="live_tip_txt">          加载中，精彩马上开始        </div>'}this.$tip.html(i).show()},s.prototype._hide_tip=function(){this.$tip.hide()},s.prototype._init_player=function(e,i){var s=this,l=s.carousel.getCurrent(),a=s.data.live[l],o=null,r=null;s.driver=new t({container:"#J_live_player",width:390,height:350,fulllife:1,volume:s.volume,src:a}).on("playing",function(){s.events.trigger("playing"),r&&clearTimeout(r),o&&clearTimeout(o),o=s.driver.setTimeout(function(){s._log(),s.driver.dispose(),s.$live.removeClass(s.ALL_STATUS).addClass("live_end"),s._show_tip("end")},1e3*s.DURATION)}).on("pause",function(){o&&clearTimeout(o),s.events.trigger("pause")}).on("waiting",function(){s.events.trigger("waiting"),s.driver&&s.driver.isLive?(o&&clearTimeout(o),r&&clearTimeout(r),r=setTimeout(function(){s.driver.reload()},1e3*s.LIVETIME_LIMIT)):(o&&clearTimeout(o),r&&clearTimeout(r),r=setTimeout(function(){s.events.trigger("error")},1e3*s.TIME_LIMIT))}).on("error",function(){r&&clearTimeout(r),o&&s.driver.clearTimeout(o),s.events.trigger("error")}).on("dispose",function(){r&&clearTimeout(r),o&&s.driver.clearTimeout(o),s.events.trigger("dispose")}).on("onroad",function(){r&&clearTimeout(r),o&&s.driver.clearTimeout(o),s.events.trigger("onroad")}).init(),"flash"==s.driver.MODE&&s.$live.addClass("live_flash")},s});