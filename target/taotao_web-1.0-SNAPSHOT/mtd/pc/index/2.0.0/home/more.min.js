define("home/widget/more",function(require,exports,module){"use strict";var e=require("conf"),t=require("load_async"),o=require("o2tpl"),n=require("report"),i=_.Class.extend({construct:function(e){this.conf=$.extend({$el:null,domStr:"",next:function(){}},e),this.init()},init:function(){this.pageNum=50,this.totalNum=100,this.pn=1,this.dataList=[],this.skuInfo=[],this.preSaleSkuInfo={},this.moreDom="",this.$doc=$(document),this.$w=$(window),this.initEvent(),this.renderMore(!0)},initEvent:function(){var e=this;this.conf.$el.delegate(".J_more_item[data-clk]","click",function(){var t=$(this);e.monitor(t.data("clk"))})},loadMoreData:function(o,n){var i=window.pageConfig,r=readCookie("pin")||"";r=decodeURIComponent(r);var a={lid:readCookie("areaId")||1,uuid:readCookie("__jda")||-1,pin:r,lim:this.totalNum,ec:"utf-8"},l=e.INTERFACE;t({url:l.MORE,params:a,jsonpCallback:"jsonpCallbackMoreGood",backup:l.MORE_BACKUP,timeout:e.TIMEOUT,dataCheck:function(e){return!("object"!=typeof e||!e.data||!$.isArray(e.data))}}).then($.proxy(function(n){var r={};if("object"==typeof n&&n.data&&$.isArray(n.data)){for(var a=0;a<n.data.length;a++){var s=n.data[a];s.img=i.FN_GetImageDomain(s.sku)+"jdcms/"+s.img,s.img=i.processImageUrl(s.img,"440x440","220x220"),this.skuInfo.push(s.sku)}r.impr=n.impr,r.list=n.data}else this.errorMonitor(n);this.skuInfo.length>0&&t({url:l.PRESALE,params:{skus:this.skuInfo.join(",")},jsonpCallback:"jsonpCallbackMorePreSale",timeout:e.TIMEOUT}).then($.proxy(function(e){if(e&&$.isArray(e)&&e.length){for(var t=0;t<e.length;t++){var n=$.inArray(e[t],this.skuInfo);n>=0&&(this.preSaleSkuInfo[n]={sku:e[t]})}r.list.forEach($.proxy(function(e,t){t in this.preSaleSkuInfo&&(this.preSaleSkuInfo[t].price=e.jp,e.isPreSale=!0)},this))}o(r)},this),function(){o(r)})},this),n)},loadPreSaleInfo:function(o,n){var i=this,r=i.preSaleSkuInfo,a=i.conf.$el;for(var l in r)l=parseInt(l,10),l>=o&&l<n&&t({url:e.INTERFACE.YUDING_PRESALE_INFO,params:{sku:r[l].sku},jsonpCallback:"jsonpCallbackMorePreSaleInfo"+l,timeout:1e3}).then(function(e){return function(t){var o="",n=a.find(".J_more_item").eq(e).find(".J_more_info_price"),i=n.find(".more_info_presale"),l=n.find(".more_info_price_txt");if(!t.type&&t.error)o=r[e].price,i.hide(),l.html(o);else{var s=t.ret;o=0===s.hideRealPrice?s.oriPrice||s.currentPrice||s.earnest+" 定金":s.earnest+"定金"}l.html(o)}}(l),function(e){return function(){var t="",o=a.find(".J_more_item").eq(e).find(".J_more_info_price"),n=o.find(".more_info_presale"),i=o.find(".more_info_price_txt");t=r[e].price,n.hide(),i.html(t)}}(l))},renderMore:function(e){var t=this,n=t.conf,i=n.$el;if(e)this.loadMoreData(function(e){if(e){if(e.title="还没逛够",e.begin=0,n.next&&n.next(),!e.list.length)return void t.hideMore();var r=e.list.slice();r.length>t.pageNum&&(e.list=r.splice(0,t.pageNum),t.dataList=r);try{var a=o(n.domStr,e);i.append(a),t.initScroll(),t.loadPreSaleInfo(e.begin,t.pageNum*t.pn),n.next&&n.next(),_.eventCenter.trigger("render:floorChange"),t.monitor(e.impr)}catch(l){n.next&&n.next(),t.hideMore(),_.console.log(l)}}else n.next&&n.next(),t.hideMore()},function(e,o){n.next&&n.next(),t.hideMore(),t.errorMonitor(null,o)});else{var r={begin:t.pageNum*t.pn},a=t.dataList.slice();if(!a.length)return void t.$w.unbind("scroll.loadMore");if(a.length>t.pageNum?(r.list=a.splice(0,t.pageNum),t.dataList=a):t.dataList=[],r.list=a,0===t.moreDom.length){var l=n.domStr.match(/\<ul class="J_more_list more_list clearfix">([\s\S]*?)<\/ul>/);l?t.moreDom=l[1]:t.moreDom=""}t.$ul||(t.$ul=i.find(".J_more_list")),t.pn++;try{var s=o(t.moreDom,r);t.$ul.append(s),t.loadPreSaleInfo(r.begin,t.pageNum*t.pn),n.next&&n.next(),_.eventCenter.trigger("render:floorChange")}catch(c){_.console.log(c)}}},hideMore:function(){var e=this.conf.$el;e.height(0).hide(),n.processHidedFloor(pageConfig.reportFloorHideHash.more),_.eventCenter.trigger("render:floorChange","more")},monitor:function(e){if(e){var t=new Image;t.src=e+"&m=UA-J2011-1&ref="+encodeURIComponent(document.referrer)+"&random="+Math.random(),t=null}},errorMonitor:function(t,o){var n=e.INTERFACE.MORE_ERR_LOG;t?t.success?t.data&&t.data.length||this.monitor(n+"2"):this.monitor(n+"1"):"timeout"===o?this.monitor(n+"3"):this.monitor(n+"4")},initScroll:function(){var e=this,t=null;e.$w.bind("scroll.loadMore",function(){t&&clearTimeout(t),t=setTimeout(function(){e.$doc.height()-(e.$w.height()+e.$doc.scrollTop())<500&&e.renderMore(!1)},60)})}});return i});